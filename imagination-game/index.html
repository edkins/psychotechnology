<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>

body {
	background: #008;
	color: #fff;
	text-align: center;
}

p#message {
	color: red;
	font-size: 50;
}

</style>
<script>

'use strict';

let timer = undefined;
let last_time = undefined;

function interval_ms() {
	return parseInt(document.getElementById('interval').value) * 1000;
}

function player_list() {
	return document.getElementById('players').value.trim().split('\n');
}

function randomize_modality() {
	const choices = document.getElementById('modality').value;
	if (choices === 'thinking-feeling') {
		if (Math.random() < 0.5) {
			return 'thinking';
		} else {
			return 'feeling';
		}
	} else {
		return 'salient';
	}
}

function randomize_message(old_message) {
	const players = player_list();
	if (players.length >= 2) {
		let circuit_break = 0;
		for (let i = 0; i < 1000; i++) {
			const modality = randomize_modality();
			const player1 = players[Math.floor(Math.random() * players.length)];
			const player2 = players[Math.floor(Math.random() * players.length)];
			if (player1 !== player2) {
				let message = null;
				switch (modality) {
					case 'salient':
						message = `${player1}, imagine what is salient for ${player2}`;
						break;
					case 'thinking':
						message = `${player1}, imagine what ${player2} is thinking`;
						break;
					case 'feeling':
						message = `${player1}, imagine what ${player2} is feeling`;
						break;
				}
				if (message !== old_message) {
					return message;
				}
			}
		}
	}
	return old_message
}

function interrupt() {
	const old_message = document.getElementById('message').textContent;
	document.getElementById('message').textContent = randomize_message(old_message);

	if (document.getElementById('ding').checked) {
		const audio = new Audio('ding.mp3');
		audio.play();
	}
}

function tick() {
	let time = new Date().getTime();
	if (time - last_time >= interval_ms()) {
		last_time = time;
		interrupt();
	}
}

function play() {
	if (timer !== undefined) {
		clearInterval(timer);
	}

	last_time = new Date().getTime();

	interrupt();
	timer = setInterval(tick,5000);
}

</script>
</head>
<body>
	<p>
	Who's playing? Enter names separated by new lines.
	</p>
	<p>
	<textarea id="players" rows="6" cols="20" autocomplete="off"></textarea>
	</p>
	<p>
	<select id="modality" autocomplete="off">
		<option value="thinking-feeling">Thinking/feeling</option>
		<option value="salient">What's salient</option>
	</select>
	</p>
	<p>
	<select id="interval" autocomplete="off">
		<option value="60">1 minute</option>
		<option value="120">2 minutes</option>
		<option value="180">3 minutes</option>
		<option value="240">4 minutes</option>
		<option value="300">5 minutes</option>
	</select>
	</p>
	<p>
	<input type="checkbox" id="ding"> Ding
	</p>
	<p>
	<input type="button" value="Play" autocomplete="off" onclick="play()">
	</p>
	<p id="message">
	</p>
</body>
</html>
